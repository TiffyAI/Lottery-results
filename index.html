<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TiffyAI Lottery Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(#111, #000);
      font-family: 'Orbitron', sans-serif;
      color: #00f0ff;
      text-align: center;
    }
    h1 {
      margin-top: 30px;
      font-size: 2em;
      text-shadow: 0 0 10px #00f0ff;
    }
    .ball-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    .ball {
      background: #00f0ff;
      color: #000;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      box-shadow: 0 0 10px #00f0ff;
    }
    button {
      background: #00f0ff;
      color: #000;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 10px #00f0ff;
    }
    a {
      color: #00f0ff;
      display: block;
      margin-top: 20px;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Lottery Results</h1>

  <h2>Your Numbers</h2>
  <div id="userNumbers" class="ball-container"></div>

  <h2>Drawn Numbers</h2>
  <div id="drawnNumbers" class="ball-container"></div>

  <div id="resultText" style="margin: 20px 0; font-size: 1.2em;"></div>

  <button id="claim1Tiffy" style="display:none;">Claim 1 TiffyAI Token</button>
  <button id="claimMatchReward" style="display:none;">Claim Match Reward</button>
  <button id="treasureBtn" style="display:none;">Claim Treasure</button>

  <a href="/Lottery-numbers">Play Again</a>

  <script>
    const rewardContractAddress = "0xF27d595F962ed722F39889B23682B39F712B4Da8";
    const rewardAbi = [
      "function transfer(address recipient, uint256 amount) external returns (bool)"
    ];

    const provider = new ethers.BrowserProvider(window.ethereum);
    let signer, rewardContract, userAddress;

    async function init() {
      const stored = localStorage.getItem("lotteryPick");
      if (!stored) return;
      const { numbers } = JSON.parse(stored);
      displayBalls("userNumbers", numbers);

      const drawn = [];
      while (drawn.length < 7) {
        const rand = Math.floor(Math.random() * 49) + 1;
        if (!drawn.includes(rand)) drawn.push(rand);
      }
      displayBalls("drawnNumbers", drawn);

      const matches = numbers.filter(n => drawn.includes(n));
      const matchCount = matches.length;
      const resultText = document.getElementById("resultText");

      if (matchCount >= 3) {
        resultText.innerText = `Congrats! You matched ${matchCount} numbers.`;
        document.getElementById("claimMatchReward").style.display = "inline-block";
      } else {
        resultText.innerText = "No win this time. You can still claim 1 TiffyAI token.";
        if (!localStorage.getItem("lottery1TiffyClaimed")) {
          document.getElementById("claim1Tiffy").style.display = "inline-block";
        }
      }

      if (localStorage.getItem("lottery1TiffyClaimed") || matchCount >= 3) {
        document.getElementById("treasureBtn").style.display = "inline-block";
      }

      signer = await provider.getSigner();
      userAddress = await signer.getAddress();
      rewardContract = new ethers.Contract(rewardContractAddress, rewardAbi, signer);
    }

    function displayBalls(containerId, numbers) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      numbers.forEach(n => {
        const div = document.createElement("div");
        div.className = "ball";
        div.innerText = n;
        container.appendChild(div);
      });
    }

    document.getElementById("claim1Tiffy").onclick = async () => {
      try {
        const tx = await rewardContract.transfer(userAddress, ethers.parseUnits("1", 18));
        await tx.wait();
        localStorage.setItem("lottery1TiffyClaimed", "true");
        alert("1 TiffyAI token claimed!");
        document.getElementById("claim1Tiffy").style.display = "none";
        document.getElementById("treasureBtn").style.display = "inline-block";
      } catch (e) {
        alert("Error: " + e.message);
      }
    };

    document.getElementById("claimMatchReward").onclick = async () => {
      const stored = JSON.parse(localStorage.getItem("lotteryPick"));
      const drawn = Array.from(document.getElementById("drawnNumbers").children).map(b => parseInt(b.innerText));
      const matchCount = stored.numbers.filter(n => drawn.includes(n)).length;
      const reward = matchCount === 3 ? 50 : matchCount === 4 ? 150 : matchCount === 5 ? 200 : matchCount === 6 ? 500 : matchCount === 7 ? 1000 : 0;

      if (reward > 0) {
        try {
          const tx = await rewardContract.transfer(userAddress, ethers.parseUnits(reward.toString(), 18));
          await tx.wait();
          alert(`${reward} TiffyAI claimed for matching ${matchCount} numbers!`);
          document.getElementById("claimMatchReward").style.display = "none";
          document.getElementById("treasureBtn").style.display = "inline-block";
        } catch (e) {
          alert("Error: " + e.message);
        }
      }
    };

    document.getElementById("treasureBtn").onclick = () => {
      window.location.href = "/treasure";
    };

    window.onload = init;
  </script>
</body>
</html>
